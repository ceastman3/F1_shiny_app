---
title: "Homework 4"
author: "Connor Eastman"
date: "2024-04-26"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
# kaggle datasets download -d rohanrao/formula-1-world-championship-1950-2020
# install.packages("shiny", "shinyWidgets")
library(shiny)
library(shinyWidgets)
library(tidyverse)
library(ggplot2)
library(leaflet)
```

# Formula 1 2023 Season Statistics Visualization

Data Collected from Kaggle dataset [Formula 1 World Championship (1950-2023)](https://www.kaggle.com/datasets/rohanrao/formula-1-world-championship-1950-2020?resource=download)
Headshots [Here](https://www.skysports.com/f1/drivers-teams)

```{r}
drivers = read.csv("./data/drivers.csv")
status = read.csv("./data/status.csv")
races = read.csv("./data/races.csv")
seasons = read.csv("./data/seasons.csv")
constructors = read.csv("./data/constructors.csv")
circuits = read.csv("./data/circuits.csv")
results = read.csv("./data/results.csv")
constructor_standings = read.csv("./data/constructor_standings.csv")

drivers = drivers |>
  mutate(full_name = paste(forename, surname)) |>
  select(-url)

races = races |>
  select("raceId", "year", "round", "circuitId", "name", "date")

races = left_join(races, circuits, by="circuitId") |>
  rename(
    race_name = name.x,
    circuit_name = name.y
  ) |>
  select(-alt, -url)

seasons <- seasons[order(seasons$year), ]
row.names(seasons) <- NULL

results = left_join(results, drivers, by="driverId") |>
  rename( driver_num = number.y ) |>
  select(-number.x)

constructor_standings = left_join(constructor_standings, 
                                  constructors, 
                                  by="constructorId") |>
  select(-positionText, -url, -constructorStandingsId)

# drivers_2023 = unique(results$driverId)
# drivers = drivers |>
#   filter(driverId %in% drivers_2023)

# circuits_2023 = unique(races$circuitId)
circuits = circuits |>
  # filter(circuitId %in% circuits_2023) |>
  select(-url)

constructors = constructors |>
  select(constructorId, constructorRef, constr_name=name, constr_nationality=nationality)

results = left_join(results, constructors, by="constructorId")

results = left_join(results, status, by="statusId")
results = left_join(results, races, by="raceId")

# head(status)
```

```{r}
season_results = results |>
      filter(year==2023) |>
      group_by(driverId, full_name, constr_name) |>
      summarise(total_points = sum(points, na.rm = TRUE), .groups = "drop")

head(season_results)
```


```{r}
ui = fluidPage(
  titlePanel(
    # img(src="f1_logo.png", align="left"),
    h1("Formula 1 Season Statistics", style={'color:white; 
                                              background-color:#FF1E00;
                                              border-radius:5px;
                                              padding:5px'})
  ),
  navbarPage(
    tabPanel("Overview",
      fluidRow(
        column(3, selectInput("stats", "Select Topic", c("Season", "Race"))),
        column(3, selectInput("season", "Select Season", unique(seasons$year), selected = "2023")),
        # column(6,
        #   conditionalPanel(
        #     condition = "input.stats == 'Race'",
        #     selectizeInput("race_search", "Select a Race", races$race_name, multiple = FALSE)
        #   )
        # )
      ),
      fluidRow(
        column(12,
          conditionalPanel(
            condition = "input.stats == 'Season'",
            h3("Total Points Per Driver", style = "color:white; background-color:#FF1E00; border-radius:5px; padding:5px"),
            plotOutput("season_standings"),
            h3("Circuit Locations", style = "color:white; background-color:#FF1E00; border-radius:5px; padding:5px"),
            leafletOutput("map"),
            h3("Race Schedule", style = "color:white; background-color:#FF1E00; border-radius:5px; padding:5px"),
            dataTableOutput("schedule")
          )
          # conditionalPanel(
          #   condition = "input.stats == 'Race'",
          #   dataTableOutput("position_table")
          # )
        )
      )
    )
  ),
  width=15
)

server = function(input, output) {
  
  # selected_raceId <- reactive({
  #   if (!is.null(input$race_search) && input$stats == "Race") {
  #     raceId <- races[races$race_name == input$race_search, "raceId"]
  #     return(raceId)
  #   }
  #   else { return(NULL) }
  # })
  
  output$map = renderLeaflet({
    races = races |>
      filter(year==input$season)
    
    leaflet(data=races) |>
      addTiles() |>
      setView(lng = -30, lat = 30, zoom = 2) |>
      addCircleMarkers(radius = 5,
                       color = "#FF1E00",
                       popup=~paste("<b>Race:</b>", race_name,
                              "<br><b>Circuit:</b>", circuit_name, 
                              "<br><b>City:</b>", location, 
                              "<br><b>Country:</b>", country,
                              "<br><b>Date:</b>", date))
  })
  
  output$season_standings = renderPlot({
    season_results = results |>
      filter(year==input$season) |>
      group_by(driverId, full_name, constr_name) |>
      summarise(total_points = sum(points, na.rm = TRUE), .groups = "drop")
  
    ggplot(season_results, aes(y=reorder(full_name, +total_points), x=total_points, fill = constr_name)) +
      geom_bar(stat="identity") +
      geom_text(aes(label = total_points), hjust = -0.2, size = 3) +
      labs(x = "Total Points", 
           y = "Driver", 
           title = "Total Points per Driver",
           fill = "Constructor") +
      theme_minimal() +
      theme(axis.text.y = element_text(size = 8),
            legend.position = "right")
  })
   
  output$schedule = renderDataTable({
    races %>%
      filter(year==input$season) |>
      select(Round=round, Date=date, Race=race_name, Circuit=circuit_name, Location=location, Country=country)
  })
   
  # output$position_table = renderDataTable({
  #   results %>%
  #     filter(year==input$season, raceId == selected_raceId()) |>
  #     select(Position=positionText, 
  #            Forname=forename, 
  #            Surname=surname, 
  #            Number=driver_num, 
  #            Nationality=nationality, 
  #            Constructor=constr_name,
  #            Time=time, 
  #            Points=points, 
  #            Status=status)
  # })
}

shinyApp(ui, server)
```

