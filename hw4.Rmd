---
title: "Homework 4"
author: "Connor Eastman"
date: "2024-04-26"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
# kaggle datasets download -d rohanrao/formula-1-world-championship-1950-2020
# install.packages("shiny", "shinyWidgets")
library(shiny)
library(shinyWidgets)
library(tidyverse)
library(ggplot2)
library(leaflet)
```

# Formula 1 2023 Season Statistics Visualization

Data Collected from Kaggle dataset [Formula 1 World Championship (1950-2023)](https://www.kaggle.com/datasets/rohanrao/formula-1-world-championship-1950-2020?resource=download)
Headshots [Here](https://www.skysports.com/f1/drivers-teams)

```{r}
drivers = read.csv("./data/drivers.csv")

races = read.csv("./data/races.csv")
races = races |>
  filter(races$year == 2023) |>
  select("raceId", "year", "round", "circuitId", "name", "date")

constructors = read.csv("./data/constructors.csv")
circuits = read.csv("./data/circuits.csv")
results = read.csv("./data/results.csv")
constructor_standings = read.csv("./data/constructor_standings.csv")
constructor_standings = constructor_standings |>
  filter(raceId >= 1098)

results = results |>
  filter(results$raceId >= 1098)

races = left_join(races, circuits, by="circuitId") |>
  rename(
    race_name = name.x,
    circuit_name = name.y
  ) |>
  select(-alt, -url)


results = left_join(results, drivers, by="driverId") |>
  rename( driver_num = number.y ) |>
  select(-number.x, -url)

constructor_standings = left_join(constructor_standings, 
                                  constructors, 
                                  by="constructorId") |>
  select(-positionText, -url, -constructorStandingsId)

# Get 2023 Season Drivers
drivers_2023 = unique(results$driverId)
drivers = drivers |>
  filter(driverId %in% drivers_2023)

circuits_2023 = unique(races$circuitId)
circuits = circuits |>
  filter(circuitId %in% circuits_2023) |>
  select(-url)


head(constructor_standings)
```

```{r}
race_results = races |>
  select(date, race_name, circuit_name, location, country)
```


```{r}
ui = fluidPage(
  titlePanel(
    # img(src="f1_logo.png", align="left"),
    h1("Formula 1 2023 Season Driver Statistics", style={'color:white; background-color:#FF1E00'})
    ),
  sidebarLayout(
    sidebarPanel(
      selectInput("stats", "Select Topic", c("Season", "Race")),
      conditionalPanel(
        condition = "input.stats == 'Race'",
        selectizeInput("race_search", "Select a Race", races$race_name, multiple = FALSE)
      )
      # conditionalPanel(
      #   condition = "input.stats == 'Driver'",
      #   selectizeInput("driver_search", "Select a Driver", drivers$surname, multiple = FALSE)
      # ),
    ),
    mainPanel(
      conditionalPanel(
        condition = "input.stats == 'Season'",
        leafletOutput("map")
      ),
      conditionalPanel(
        condition = "Race",
        dataTableOutput("position_table")
      ),
      # plotOutput("team_stats"),
      setBackgroundColor("#FF1E00")
    )
  )
)

server = function(input, output) {
  
  selected_raceId <- reactive({
    if (!is.null(input$race_search) && input$stats == "Race") {
      raceId <- races[races$race_name == input$race_search, "raceId"]
      return(raceId)
    }
    else { return(NULL) }
  })
  
   output$map <- renderLeaflet({
    leaflet(data=races) |>
      addTiles() |>
      setView(lng = -30, lat = 30, zoom = 2) |>
      addMarkers(popup=~paste("<b>Race:</b>", race_name,
                              "<br><b>Circuit:</b>", circuit_name, 
                              "<br><b>City:</b>", location, 
                              "<br><b>Country:</b>", country,
                              "<br><b>Date:</b>", date))
  })
   
  output$position_table = renderDataTable({
    results %>%
      filter(raceId == selected_raceId()) |>
      select(position, points, forename, surname, driver_num, nationality, time, statusId)
  })
}

shinyApp(ui, server)
```


```{r}

for(i in 1:nrow(circuits)) {
        # addMarkers(lng = circuits$lng[i], lat = circuits$lat[i], popup = circuits$name[i])
    # sprintf("%s: (%.2f, %.2f)", circuits$name[i], circuits$lat[i], circuits$lng[i])
  print(circuits$name[i])
}

```

